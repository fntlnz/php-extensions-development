<!doctype html>
<html lang="en">

<head>
<meta charset="utf-8">

<title>PHP Extensions Development</title>

<meta name="description" content="A framework for easily creating beautiful presentations using HTML">
<meta name="author" content="Hakim El Hattab">

<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link rel="stylesheet" href="css/reveal.min.css">
<link rel="stylesheet" href="css/theme/default.css" id="theme">

<!-- For syntax highlighting -->
<link rel="stylesheet" href="lib/css/zenburn.css">

<!-- If the query includes 'print-pdf', include the PDF print sheet -->
<script>
if (window.location.search.match(/print-pdf/gi)) {
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.type = 'text/css';
    link.href = 'css/print/pdf.css';
    document.getElementsByTagName('head')[0].appendChild(link);
}
</script>

<!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
</head>

<body>

<div class="reveal">

    <!-- Any section element inside of this container is displayed as a slide -->
    <div class="slides">
        <section>
            <h1>PHP Extensions Development</h1>

            <p>
            <small>Created by Lorenzo Fontana / <a
                    href="http://github.com/fntlnz">@fntlnz</a></small>
            </p>

        </section>
        <section>
            <h2>Topics</h2>
            <ul>
                <li>Why an extension?</li>
                <li>PHP Life cycles</li>
                <li>Build Environment Setup</li>
                <li>Hello World</li>
                <li>Memory management</li>
                <li>Variables and Data Types</li>
                <li>Objects</li>
                <li>Debugging</li>
                <li>What's next?</li>
            </ul>
        </section>
        <section>
            <section>
                <h2>Why an extension</h2>
                <h3>What extensions can do?</h3>
                <p>BOOOh</p>
            </section>
        </section>
        <section>
            <section>
                <h2>PHP Life cycles</h2>
            </section>
            <section>
                <h3>CLI (Single request life cycle)</h3>
                <p><img src="/files/images/cli-life-cycle.png" alt="CLI Life Cycle"></p>
            </section>
            <section>
                <h3>Apache Prefork MPM (Multiprocess life cycles)</h3>
                <p><img src="/files/images/multiprocess-life-cycles.png" alt="MultiProcess Life Cycles"></p>
            </section>
            <section>
                <h3>Apache Worker MPM (Multithreaded life cycles)</h3>
                <p><img src="/files/images/multithreaded-life-cycles.png" alt="Multithreaded Life Cycles"></p>
            </section>
        </section>
        <section>
            <section>
                <h2>Build Environment Setup</h2>
            </section>
            <section>
                <p>Grab the latest version of PHP from Github</p>
                <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px;">git clone https://github.com/php/php-src.git
git checkout tags/php-5.6.3         
                </code></pre>
            </section>
            <section>
                <p>Configure it for PHP Development</p>
                <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px;">./configure --prefix=/tmp/php-debug --enable-debug --enable-maintainer-zts \
--disable-cgi --enable-cli --disable-pear --with-readline</code></pre>
                <p>
                <ul style="font-size:28px">
                    <li><strong>enable-debug</strong> :Memory leaks reporting and compile with debugging symbols</li>
                    <li><strong>enable-maintainer-zts</strong> : Build with the thread-safe resource manager 
                </ul>
                </p>
            </section>
            <section>
                <p>Make and install</p>
                <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px;">make -j2
sudo make install</code></pre>
                 <p>According to our configuration options this will compile PHP and install it into the /tmp/php-debug folder.</p>
                 <br>
                 <p>To use it temporarily in place of your working PHP just prepend it's location to the <strong>$PATH</strong></p>
                <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px;">export $PATH="/tmp/php-debugi/bin:$PATH"</code></pre>

                <br>
                <p>Now issuing a <i>php -v</i> should show something like</p>
                <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px;">PHP 5.6.3 (cli) (built: Oct 20 2014 19:00:00) (DEBUG)
Copyright (c) 1997-2014 The PHP Group
Zend Engine v2.6.0, Copyright (c) 1998-2014 Zend Technologies
                </code></pre>
 
            </section>
            <section>
            <h3>Just remember that</h3>
            <pre><code data-trim contenteditable>PHP With Debug Flags === Overhead</code></pre>

            <table class="reveal">
                <tr>
                    <td>PHP</td>
                    <td>PHP (DEBUG)</td>
                </tr>
                <tr>
                    <td>
            <pre><code class="bash" data-trim contenteditable>
php Zend/bench.php                 
simple             0.058
simplecall         0.083
simpleucall        0.087
simpleudcall       0.088
mandel             0.145
mandel2            0.198
ackermann(7)       0.078
ary(50000)         0.014
ary2(50000)        0.015
ary3(2000)         0.123
fibo(30)           0.275
hash1(50000)       0.025
hash2(500)         0.022
heapsort(20000)    0.058
matrix(20)         0.064
nestedloop(12)     0.111
sieve(30)          0.075
strcat(200000)     0.009
------------------------
Total              1.527
            </code></pre>
        </td>
        <td>
 <pre><code class="bash" data-trim contenteditable>
 php Zend/bench.php 
 simple             0.234
 simplecall         0.433
 simpleucall        0.479
 simpleudcall       0.482
 mandel             0.606
 mandel2            0.896
 ackermann(7)       0.412
 ary(50000)         0.058
 ary2(50000)        0.054
 ary3(2000)         0.396
 fibo(30)           1.404
 hash1(50000)       0.088
 hash2(500)         0.099
 heapsort(20000)    0.234
 matrix(20)         0.205
 nestedloop(12)     0.355
 sieve(30)          0.247
 strcat(200000)     0.033
 ------------------------
 Total              6.716
            </code></pre>
        </tr>
    </table>
            </section>
        </section>
        <section>
            <section>
                <h2>Hello World PHP Extension</h2>
            </section>
            <section data-state="customevent">
                <h3>config.m4</h3>
                <p>Template to generate a <code class="bash" style="font-size: 0.7em">configure</code> script with phpize.</p>
                    <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px;">
dnl config.m4 for extension hello_world

PHP_ARG_WITH(hello_world, whether to enable hello world support,
[ --enable-hello-world Enable hello world])

if test "$PHP_HELLOWORLD" != "no"; then
    PHP_NEW_EXTENSION(hello_world, hello_world.c, $ext_shared)
fi
                </code></pre>
            </section>
            <section data-state="customevent">
                <h3>php_hello_world.h</h3>
                <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px;" class="c">
#ifndef PHP_HELLO_WORLD_H
#define PHP_HELLO_WORLD_H

#ifdef HAVE_CONFIG_H
#include "config.h"
#endif

#include "php.h"

#define PHP_HELLO_WORLD_NAME "hello_world" /* Replace with name of your extension */
#define PHP_HELLO_WORLD_VERSION "0.1.0" /* Replace with version number for your extension */

#endif	/* PHP_HELLO_WORLD_H */
                </code></pre>
            </section>
            <section data-state="customevent">
                <h3>hello_world.c</h3>
                <pre><code data-trim contenteditable style="font-size: 15px; margin-top: 20px" class="c">
#include "php_hello_world.h"

PHP_FUNCTION (hello_world) {
    char *arg = NULL;
    size_t arg_len, len;

    if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, "s", &arg, &arg_len) == FAILURE) {
        return;
    }

    char greet[1024];
    strcpy(greet, "Hi ");
    strcat(greet, arg);
    strcat(greet, "!");

    RETURN_STRING(greet, 1);
}

PHP_MINIT_FUNCTION (hello_world) {
            <p>This is a simple benchmark with the CLI Sapi to appreciate the difference.</p>
    return SUCCESS;
}

const zend_function_entry hello_world_functions[] = {
    PHP_FE(hello_world, NULL)
    PHP_FE_END
};

zend_module_entry hello_world_module_entry = {
    STANDARD_MODULE_HEADER,
    PHP_HELLO_WORLD_NAME,
    hello_world_functions,
    PHP_MINIT(hello_world),
    NULL,
    NULL,
    NULL,
    NULL,
    PHP_HELLO_WORLD_VERSION,
    STANDARD_MODULE_PROPERTIES
};

#ifdef COMPILE_DL_HELLO_WORLD
ZEND_GET_MODULE(hello_world)
#endif
                </code></pre>
            </section>

            <section data-state="customevent">
                <h3>Configure and Build Dinamically</h3>
                <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px" class="bash">
                        phpize
                </code></pre>
                <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px" class="bash">
                        ./configure
                </code></pre>
                <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px" class="bash">
                        make
                </code></pre>
                <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px" class="bash">
                        php -d extension=modules/hello_world.so -r 'echo hello_world("Lorenzo");'
                </code></pre>
            </section>
        </section>
        <section>
            <section>
                <h2>Memory Management</h2>
            </section>
        </section>
        <section>
            <section>
                <h2>Variables and Data Types</h2>
            </section>
        </section>
        <section>
            <section>
                <h2>Objects</h2>
            </section>
        </section>
        <section>
            <section>
                <h2>Debugging</h2>
            </section>
            <section>
                <h3>Just GDB</h3>
                <pre style="width: 110%"><code>gdb --tui --args php -d extension=modules/hello_world.so -r 'echo hello_world("Lorenzo");'</code></pre>
                <h3>Or perhaps CGDB</h3>
                <pre style="width: 110%"><code>cgdb --args php -d extension=modules/hello_world.so -r 'echo hello_world("Lorenzo");'</code></pre>
            </section>
            <section>
                <h3>Macro Expansion</h3>
            </section>
        </section>
        <section>
            <h2>What's next</h2>
            Embedding, streams etc...
        </section>
        <section class="present stack" style="display: block;">
            <section class="future" style="display: block;">
                <h2>References</h2>

                <h3>Spaghetti.io</h3>
                <ul>
                    <li><a href="http://spaghetti.io/cont/article/getting-started-with-php-extensions-development/52/1.html">Getting started with PHP Extensions development</a></li>
                </ul>
                <h3>Web</h3>
                <ul>
                    <li><a href="https://github.com/php/php-src/tree/master/ext">php-src/ext</a></li>
                    <li><a href="https://github.com/search?l=C&q=php&type=Repositories&utf8=%E2%9C%93">Search for PHP
                        filtering for C language on GitHub</a></li>
                    <li><a href="http://phpinternalsbook.com">phpinternalsbook.com</a></li>
                    <li><a href="http://devzone.zend.com/303/extension-writing-part-i-introduction-to-php-and-zend/">Extension
                        Writing Part I: Introduction to PHP and Zend</a></li>
                    <li><a href="http://devzone.zend.com/317/extension-writing-part-ii-parameters-arrays-and-zvals">Extension
                        Writing Part II: Parameters, Arrays, and ZVALs</a></li>
                </ul>
                <h3>Books</h3>
                <ul>
                    <li><a href="http://amzn.com/067232704X">Extending and Embedding PHP by Sara Golemon</a></li>
                </ul>
            </section>
        </section>
        <section>
            <h1>Questions?</h1>
        </section>
    </div>

</div>

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.min.js"></script>

<script>

// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({
controls: true,
progress: true,
history: true,
center: true,

theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

// Parallax scrolling
// parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
// parallaxBackgroundSize: '2100px 900px',

// Optional libraries used to extend on reveal.js
dependencies: [
{
src: 'lib/js/classList.js', condition: function () {
return !document.body.classList;
}
},
{
src: 'plugin/markdown/marked.js', condition: function () {
         return !!document.querySelector('[data-markdown]');
     }
},
{
src: 'plugin/markdown/markdown.js', condition: function () {
         return !!document.querySelector('[data-markdown]');
     }
},
{
src: 'plugin/highlight/highlight.js', async: true, callback: function () {
         hljs.initHighlightingOnLoad();
     }
},
{
src: 'plugin/zoom-js/zoom.js', async: true, condition: function () {
         return !!document.body.classList;
     }
},
{
src: 'plugin/notes/notes.js', async: true, condition: function () {
         return !!document.body.classList;
     }
}
]
});

</script>

</body>
</html>
